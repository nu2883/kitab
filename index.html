<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kitab Kuning ‚Äî Per Halaman (Klik kata)</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <!-- Font Arab (Amiri) -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            transition: background 0.3s, color 0.3s;
        }

        body.light {
            background: linear-gradient(180deg, #f4e2a3 0%, #f9f1d1 40%, #fdf9e6 100%);
            color: #2c2a24;
        }

        body.dark {
            background: #1f2937;
            color: #f3f4f6;
        }

        .book {
            background: linear-gradient(180deg, #fff9e5 0%, #fff7d8 100%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            border-radius: 10px;
            padding: 28px;
            width: 96%;
            max-width: 1200px;
            min-height: 60vh;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            transition: background 0.3s, color 0.3s;
            margin-top: 150px;
        }

        body.dark .book {
            background: #374151;
            color: #f3f4f6;
            border-color: rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 768px) {
            .book {
                width: 100%;
                border-radius: 0;
                padding: 20px;
                margin-top: 160px;
            }
        }

        .book-header {
            font-family: 'Amiri', serif;
            font-size: 1.1rem;
            color: #5b4636;
            text-align: center;
            margin-bottom: 6px;
            letter-spacing: .02em;
        }

        body.dark .book-header {
            color: #f3f4f6;
        }

        .page-paragraph {
            direction: rtl;
            text-align: right;
            font-family: 'Amiri', serif;
            line-height: 2.0;
            padding: 12px;
            margin-bottom: 12px;
            word-break: keep-all;
            position: relative;
        }

        .arab-word {
            display: inline-block;
            margin-left: 0.6rem;
            margin-right: 0.2rem;
            padding: 0.08rem 0.28rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background .12s, transform .08s;
            user-select: none;
            position: relative;
        }

        .arab-word:hover {
            background: rgba(34, 197, 94, 0.08);
            transform: translateY(-2px);
        }

        .arab-word.active {
            background: rgba(34, 197, 94, 0.2);
            transform: translateY(-2px);
        }

        /* Fixed Header Controls */
        .header-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #f4e2a3 0%, #f9f1d1 100%);
            padding: 12px 20px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-controls1 {
            position: fixed;
            top: 55px;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #f4e2a3 0%, #f9f1d1 100%);
            padding: 12px 20px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark .header-controls {
            background: #1f2937;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Bubble Dialog Fixed di Tengah Atas */
        .bubble-dialog-fixed {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 999;
            max-width: 500px;
            width: 90%;
            animation: fadeIn 0.2s ease-out;
            border: 1px solid #e5e7eb;
            font-family: 'Amiri', serif;
        }

        body.dark .bubble-dialog-fixed {
            background: #374151;
            color: #f3f4f6;
            border-color: #4b5563;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .bubble-header {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
            font-size: 1.8rem;
        }

        body.dark .bubble-header {
            border-bottom-color: #4b5563;
        }

        .bubble-content {
            line-height: 1.6;
            text-align: center;
        }

        .bubble-meaning {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .bubble-kedudukan {
            font-size: 1rem;
            color: #4b5563;
            font-style: italic;
        }

        body.dark .bubble-kedudukan {
            color: #d1d5db;
        }

        .bubble-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }

        body.dark .bubble-actions {
            border-top-color: #4b5563;
        }

        .bubble-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
        }

        .bubble-btn-primary {
            background: #10b981;
            color: white;
        }

        .bubble-btn-secondary {
            background: #e5e7eb;
            color: #4b5563;
        }

        body.dark .bubble-btn-secondary {
            background: #4b5563;
            color: #e5e7eb;
        }

        /* Kamus Saya Modal */
        .dictionary-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dictionary-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        body.dark .dictionary-content {
            background: #374151;
            color: #f3f4f6;
        }

        .dictionary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        body.dark .dictionary-header {
            border-bottom-color: #4b5563;
        }

        .dictionary-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .dictionary-close {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
        }

        .dictionary-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }

        .dictionary-item {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            transition: transform 0.2s;
        }

        body.dark .dictionary-item {
            background: #4b5563;
        }

        .dictionary-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .dictionary-arabic {
            font-family: 'Amiri', serif;
            font-size: 1.5rem;
            text-align: right;
            margin-bottom: 8px;
        }

        .dictionary-meaning {
            margin-bottom: 6px;
        }

        .dictionary-kedudukan {
            font-size: 0.85rem;
            color: #6b7280;
            font-style: italic;
        }

        body.dark .dictionary-kedudukan {
            color: #d1d5db;
        }

        .dictionary-hal {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 8px;
        }

        .dictionary-empty {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-style: italic;
        }

        .dictionary-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -10px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .theme-toggle {
            background: #6366f1;
            color: #fff;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .dictionary-toggle {
            background: #8b5cf6;
            color: #fff;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .font-control {
            display: flex;
            gap: 4px;
        }

        .font-control button {
            background: #facc15;
            color: #fff;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .page-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-input input {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 80px;
            text-align: center;
        }

        .page-input button {
            padding: 6px 12px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
      .is-reading {
    background-color: yellow; /* Contoh warna highlight */
    font-weight: bold;
}
.arab-word.has-meaning {
    position: relative; /* Diperlukan untuk menempatkan pseudo-element */
    padding-bottom: 1.5rem; /* Memberi ruang di bawah kata untuk arti */
    display: inline-block; /* Agar padding berfungsi */
}

.arab-word.has-meaning::after {
    content: attr(data-meaning);
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%) rotate(45deg); /* Nilai sudut diubah menjadi 270 derajat */
    white-space: nowrap;
    font-size: 0.5em;
    color: #555;
    
}
    </style>
</head>

<body>

    <div id="app" class="w-full flex flex-col items-center gap-6 py-10">

        <!-- Fixed Header Controls -->
        <div class="header-controls">

            <div class="header-left">
                <button class="theme-toggle" @click="toggleTheme">
                    {{ theme === 'light' ? 'üåô' : '‚òÄÔ∏è' }}
                </button>
                <button class="dictionary-toggle" @click="showDictionary = true">
                    üìö
                </button>
            </div>

            <div class="header-center">
                <div class="page-input">
                    <div class="text-sm text-gray-600 dark:text-white"></div>
                    <input v-model.number="noHalaman" type="number" min="1" placeholder="Contoh: 31"
                        @keyup.enter="insertThenFetch">
                    <button @click="insertThenFetch" :disabled="loading || !noHalaman">
                        Tampil
                    </button>
                </div>
            </div>

            <div class="header-right">
                <div class="font-control">
                    <button @click="changeFontSize(2)">+</button>
                    <button @click="changeFontSize(-2)">-</button>
                </div>
            </div>

        </div>
<div class="header-controls1 flex items-center gap-3">
    <label class="flex items-center gap-1">
        <input type="checkbox" v-model="showArabic">
        <span>Harokat</span>
    </label>

    <label class="flex items-center gap-1">
        <input type="checkbox" v-model="showMeaning">
        <span>Arti</span>
    </label>

    <label class="flex items-center gap-1">
        <span>TTS:</span>
        <select v-model="ttsMode" class="border rounded px-2 py-1">
            <option value="arab-arti">Arab + Arti</option>
            <option value="arab">Arab saja</option>
        </select>
    </label>

    <button @click="startReadingAll()">
        üîä Baca
    </button>
</div>



<div v-if="activeBubble" class="bubble-dialog-fixed">
    <div class="bubble-header">{{ activeBubble.item.arab }}</div>
    <div class="bubble-content">
        <div class="bubble-meaning">{{ activeBubble.item.arti || '(tidak ada)' }}</div>
        <div class="bubble-kedudukan">{{ activeBubble.item.kedudukan || '(tidak ada)' }}</div>
    </div>
    <div class="bubble-actions">
        <button class="bubble-btn bubble-btn-primary" @click="addToMyDictionary(activeBubble.item, activeBubble.part)">
            Simpan
        </button>
        <button class="bubble-btn bubble-btn-secondary" @click="closeBubble">
            Tutup
        </button>
    </div>
</div>

        <!-- Kamus Saya Modal -->
        <div v-if="showDictionary" class="dictionary-modal">
            <div class="dictionary-content">
                <div class="dictionary-header">
                    <h2 class="dictionary-title">üìö Kamus Saya</h2>
                    <button class="dictionary-close" @click="showDictionary = false">Tutup</button>
                </div>

                <div v-if="myDictionary.length === 0" class="dictionary-empty">
                    Kamus Anda masih kosong. Klik kata Arab untuk menambahkannya ke kamus.
                </div>

                <div v-else class="dictionary-list">
                    <div v-for="(word, index) in myDictionary" :key="index" class="dictionary-item">
                        <div class="dictionary-arabic">{{ word.arab }}</div>
                        <div class="dictionary-meaning"><strong>Arti:</strong> {{ word.arti }}</div>
                        <div class="dictionary-kedudukan"><strong>Kedudukan:</strong> {{ word.kedudukan }}</div>
                        <div class="dictionary-hal">Halaman: {{ word.hal }}</div>
                        <button class="bubble-btn bubble-btn-secondary" @click="removeFromDictionary(index)"
                            style="margin-top: 10px; font-size: 0.8rem;">
                            Hapus
                        </button>
                    </div>
                </div>

                <!-- <div v-if="myDictionary.length > 0" class="dictionary-actions">
                    <button class="bubble-btn bubble-btn-secondary" @click="clearDictionary">
                        Hapus Semua
                    </button>
                    <button class="bubble-btn bubble-btn-primary" @click="exportDictionary">
                        Ekspor Kamus
                    </button>
                </div> -->
            </div>
        </div>

        <div class="book">
            <div class="book-header">ÿßŸÑŸÉÿ™ÿßÿ® ‚Äî Al I'tiqod Imam Baihaqi</div>



            <div v-if="loading" class="p-6 text-center text-sm text-gray-600">Memproses‚Ä¶ tunggu sebentar</div>

            <div v-else>
                <div v-if="pageRows.length === 0" class="p-8 text-center text-gray-600 italic">Tidak ada entri untuk
                    halaman ini.</div>

                <div v-if="pageRows.length" class="page-paragraph" :style="{ fontSize: fontSizeArabic + 'px' }"
                    aria-live="polite">
                    <div>
                        <!-- {{pageRows}} -->
                    </div>
<template v-for="(item, idx) in pageRows">
    <template v-for="(part, j) in splitWords(showArabic ? item.arab : item.noHarokat)">
        <span class="arab-word" :key="idx + '-' + j"
            :class="{ 
                active: activeBubble && activeBubble.part === part && activeBubble.item === item,
                'is-reading': isSpeaking && activeWordIndex === (idx + '-' + j),
                'has-meaning': showMeaning
            }"
            :data-meaning="item.arti || '(tidak ada)'"
            @click="handleWordClick(item, part, idx + '-' + j, $event)">
            {{ part }}
        </span>
    </template>
    <span style="display:inline-block; width:0.4rem;"></span>
</template>
                </div>

                <!-- Tombol navigasi -->
                <div class="mt-4 w-full flex justify-between">
                    <button @click="prevPage" class="px-4 py-2 rounded bg-yellow-500 text-white hover:bg-yellow-600">‚Üê
                        Prev Halaman</button>
                    <button @click="nextPage"
                        class="px-4 py-2 rounded bg-yellow-500 text-white hover:bg-yellow-600">Next Halaman ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
        data() {
    return {
        GAS_BASE: 'https://script.google.com/macros/s/AKfycby025S9w4zqYOhMzReoyu2EOauP-7uVJZCFbCiC_lrclg9WXNapzwxGwo7LLW7sV15G6A/exec',
        darkMode: false,
        showArabic: true,
        ttsMode: 'arab-arti',
        speaking: false,
        sentences: [],
        currentSentenceIndex: 0,
        currentUtterance: null,
        activeBubble: null,
        noHalaman: null,
        loading: false,
        raw: null,
        rows: [],
        pageRows: [],
        fontSizeArabic: 26,
        theme: 'light',
        showDictionary: false,
        myDictionary: [],
        
        isSpeaking: false,
        activeWordIndex: null,
        spokenWords: [],
        currentWordIndex: 0,
         isBubbleManuallyClosed: false,
          showMeaning: false,
    };
},
            computed: {
 fullText() {
    if (!this.pageRows || this.pageRows.length === 0) {
      return '';
    }

    if (this.ttsMode === 'arab-arti') {
      return this.pageRows.map(row => `${row.latin}. ${row.arti}.`).join(' ');
    } else {
      return this.pageRows.map(row => `${row.latin}.`).join(' ');
    }
  },
                readUrl() { return this.GAS_BASE + '?action=read&table=query1'; },
                insertUrlBase() { return this.GAS_BASE + '?action=insert&table=request&data='; }
            },
            methods: {
    // Metode untuk menangani klik pada kata
    handleWordClick(item, part, wordIndex, event) {
        this.openBubble(item, part, event);
        if (this.isSpeaking && this.activeWordIndex === wordIndex) {
            this.stopReading();
        } else {
            this.startReadingFromWord(item, part, wordIndex);
        }
    },

    // Metode untuk memulai pembacaan dari kata yang diklik
    startReadingFromWord(item, part, wordIndex) {
        this.stopReading();
        this.isSpeaking = true;
        this.isBubbleManuallyClosed = false; // Reset flag saat memulai pembacaan
        this.activeWordIndex = wordIndex;

        // Bangun daftar kata yang akan diucapkan, lengkap dengan indeks asli
        const startRowIndex = this.pageRows.findIndex(row => row === item);
        this.spokenWords = [];

        for (let i = startRowIndex; i < this.pageRows.length; i++) {
            const row = this.pageRows[i];
            const originalWords = this.splitWords(this.showArabic ? row.arab : row.noHarokat);

            originalWords.forEach((word, j) => {
                this.spokenWords.push({
                    text: this.ttsMode === 'arab-arti' ? `${row.latin}. ${row.arti}` : row.latin,
                    originalIndex: `${i}-${j}`
                });
            });
        }

        // Temukan indeks awal untuk memulai pembacaan
        const startIndex = this.spokenWords.findIndex(word => word.originalIndex === wordIndex);
        if (startIndex !== -1) {
            this.currentWordIndex = startIndex;
        } else {
            this.currentWordIndex = 0;
        }
        
        this.readNextWord();
    },

    // Logika utama pembacaan kata per kata
    async readNextWord() {
        if (!this.isSpeaking || this.currentWordIndex >= this.spokenWords.length) {
            this.stopReading();
            return;
        }

        const wordData = this.spokenWords[this.currentWordIndex];
        const textToSpeak = wordData.text;
        
        this.activeWordIndex = wordData.originalIndex;

        // Perbarui activeBubble hanya jika tidak ditutup secara manual
        if (!this.isBubbleManuallyClosed) {
            const [rowIndex, partIndex] = wordData.originalIndex.split('-');
            const originalItem = this.pageRows[rowIndex];

            if (originalItem) {
                this.activeBubble = {
                    item: originalItem,
                    part: this.splitWords(this.showArabic ? originalItem.arab : originalItem.noHarokat)[partIndex]
                };
            }
        }

        try {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(textToSpeak);
            const loadedVoices = window.speechSynthesis.getVoices() || [];
            
            let chosen = loadedVoices.find(v => v.lang && v.lang.toLowerCase().startsWith('id'));
            if (!chosen) chosen = loadedVoices.find(v => v.lang && v.lang.toLowerCase().includes('indonesia'));
            if (!chosen && loadedVoices.length) chosen = loadedVoices[0];
            
            if (chosen) {
                u.voice = chosen;
                u.lang = chosen.lang;
            } else {
                u.lang = 'id-ID';
            }
            
            u.rate = 1.0;
            u.pitch = 1.0;
            
            u.onend = () => {
                this.currentWordIndex++;
                this.readNextWord();
            };
            
            u.onerror = (e) => {
                console.error('TTS error', e);
                this.stopReading();
            };
            
            window.speechSynthesis.speak(u);
        } catch (e) {
            console.error('TTS error', e);
            this.stopReading();
        }
    },

    // Metode untuk menghentikan pembacaan
    stopReading() {
        try {
            window.speechSynthesis.cancel();
        } catch (e) {}
        this.isSpeaking = false;
        this.activeWordIndex = null;
        this.currentWordIndex = 0;
        this.spokenWords = [];
        this.isBubbleManuallyClosed = false; // Reset flag saat pembacaan berhenti
    },

    // Metode untuk tombol 'Baca Seluruh Halaman'
    startReadingAll(mode) {
        this.stopReading();
        this.isBubbleManuallyClosed = false; // Reset flag saat memulai pembacaan halaman penuh
        if (!this.fullText.trim()) {
            alert('Tidak ada teks untuk dibaca.');
            return;
        }
        this.isSpeaking = true;
        this.currentWordIndex = 0;
        this.spokenWords = [];

        this.pageRows.forEach((row, i) => {
            const originalWords = this.splitWords(this.showArabic ? row.arab : row.noHarokat);
            originalWords.forEach((word, j) => {
                this.spokenWords.push({
                    text: this.ttsMode === 'arab-arti' ? `${row.latin}. ${row.arti}` : row.latin,
                    originalIndex: `${i}-${j}`
                });
            });
        });

        this.readNextWord();
    },

    // Metode pembantu untuk memecah teks menjadi kata-kata
    splitWords(text) {
        if (!text) return [];
        return text.split(/\s+/).filter(Boolean);
    },

    // Metode untuk menutup gelembung
    closeBubble() {
        this.activeBubble = null;
        this.isBubbleManuallyClosed = true;
    },

    // Metode untuk membuka gelembung
    openBubble(item, part, event) {
        this.activeBubble = {
            item: item,
            part: part
        };
        this.isBubbleManuallyClosed = false;
    },

    // --- Metode lainnya (tidak diubah) ---
    addToMyDictionary(item, part) {
        const exists = this.myDictionary.some(k => k.arab === part && k.hal === item.hal);
        if (!exists) {
            this.myDictionary.push({
                arab: part,
                arti: item.arti,
                kedudukan: item.kedudukan,
                hal: item.hal,
                row: item.row
            });
            localStorage.setItem('myDictionary', JSON.stringify(this.myDictionary));
            alert('Kata "' + part + '" berhasil ditambahkan ke Kamus Saya!');
        } else {
            alert('Kata "' + part + '" sudah ada di Kamus Saya.');
        }
        this.closeBubble();
    },
    removeFromDictionary(index) {
        if (confirm('Hapus kata ini dari Kamus Saya?')) {
            this.myDictionary.splice(index, 1);
            localStorage.setItem('myDictionary', JSON.stringify(this.myDictionary));
        }
    },
    clearDictionary() {
        if (confirm('Hapus semua kata dari Kamus Saya?')) {
            this.myDictionary = [];
            localStorage.setItem('myDictionary', JSON.stringify(this.myDictionary));
        }
    },
    exportDictionary() {
        const dataStr = JSON.stringify(this.myDictionary, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        const exportFileDefaultName = 'kamus-saya.json';
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    },
    loadDictionary() {
        const saved = localStorage.getItem('myDictionary');
        this.myDictionary = saved ? JSON.parse(saved) : [];
    },
    async insertThenFetch() {
        if (!this.noHalaman) return;
        this.loading = true;
        this.clearView(false);
        localStorage.setItem('kitab_noHalaman', this.noHalaman);
        localStorage.setItem('kitab_fontSize', this.fontSizeArabic);
        try {
            await this._doInsert();
        } catch (e) {
            console.warn(e);
        }
        await this._sleep(2000);
        await this.loadPage();
        this.loading = false;
    },
    async _doInsert() {
        const now = this._now();
        const payload = {
            no: now.ts,
            tanggal: now.date,
            waktu: now.time,
            noHalaman: Number(this.noHalaman)
        };
        const url = this.insertUrlBase + encodeURIComponent(JSON.stringify(payload));
        const res = await fetch(url, {
            method: 'GET'
        });
        const text = await res.text();
        try {
            this.raw = JSON.parse(text);
        } catch (e) {
            this.raw = text;
        }
        if (!res.ok) throw new Error('Insert gagal HTTP ' + res.status);
    },
    async loadPage() {
        try {
            const res = await fetch(this.readUrl, {
                method: 'GET'
            });
            const text = await res.text();
            let data = null;
            try {
                data = JSON.parse(text);
            } catch (e) {
                data = null;
            }
            this.raw = data !== null ? data : text;
            let normalized = [];
            if (data && typeof data === 'object') {
                if (Array.isArray(data.data)) normalized = data.data;
                else if (Array.isArray(data.rows)) normalized = data.rows;
                else if (Array.isArray(data.pending) || Array.isArray(data.uploaded)) normalized = (data.pending || []).concat(data.uploaded || []);
                else if (Array.isArray(data)) normalized = data;
                else if (data.no || data.arab) normalized = [data];
                else normalized = [];
            } else if (Array.isArray(data)) normalized = data;
            else normalized = [];
            normalized = normalized.map(r => ({
                no: r.no ?? r.No ?? '',
                arab: r.arab ?? r.A ?? '',
                arti: r.arti ?? r.Arti ?? r.meaning ?? '',
                kedudukan: r.kedudukan ?? r.Kedudukan ?? r.ked ?? '',
                noHarokat: r.noHarokat ?? r.noH ?? '',
                latin: r.latin ?? r.lat ?? '',
                hal: Number(r.hal ?? r.h ?? r.page ?? 0),
                row: r.row ?? r.R ?? ''
            }));
            normalized.sort((a, b) => (Number(a.row) || 0) - (Number(b.row) || 0));
            this.rows = normalized;
            this.pageRows = this.rows.filter(r => Number(r.hal) === Number(this.noHalaman));
            localStorage.setItem('kitab_data_' + this.noHalaman, JSON.stringify(this.pageRows));
        } catch (err) {
            console.error(err);
            this.rows = [];
            this.pageRows = [];
        }
    },
    clearView(clearPage = true) {
        if (clearPage) this.noHalaman = null;
        this.rows = [];
        this.pageRows = [];
        this.raw = null;
        this.closeBubble();
    },
    _now() {
        const ts = Date.now();
        const d = new Date(ts);
        const dateOptions = {
            timeZone: 'Asia/Jakarta',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        };
        const parts = new Intl.DateTimeFormat('id-ID', dateOptions).format(d).split('/');
        const tanggal = `${parts[2]}-${parts[1]}-${parts[0]}`;
        const timeOptions = {
            timeZone: 'Asia/Jakarta',
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        const waktu = new Intl.DateTimeFormat('en-GB', timeOptions).format(d);
        return {
            ts,
            date: tanggal,
            time: waktu
        };
    },
    _sleep(ms) {
        return new Promise(res => setTimeout(res, ms));
    },
    nextPage() {
        this.noHalaman++;
        this.insertThenFetch();
    },
    prevPage() {
        if (this.noHalaman > 1) {
            this.noHalaman--;
            this.insertThenFetch();
        }
    },
    changeFontSize(delta) {
        this.fontSizeArabic += delta;
        localStorage.setItem('kitab_fontSize', this.fontSizeArabic);
    },
    toggleTheme() {
        this.theme = this.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('kitab_theme', this.theme);
        document.body.className = this.theme;
        this.darkMode = this.theme === 'dark';
    }
},mounted() {
                // Theme
                const savedTheme = localStorage.getItem('kitab_theme');
                this.theme = savedTheme || 'light';
                document.body.className = this.theme;
                this.darkMode = this.theme === 'dark';

                // Font size
                const savedFont = localStorage.getItem('kitab_fontSize');
                if (savedFont) this.fontSizeArabic = Number(savedFont);

                // Last page
                const savedPage = localStorage.getItem('kitab_noHalaman');
                if (savedPage) {
                    this.noHalaman = Number(savedPage);
                    const savedData = localStorage.getItem('kitab_data_' + savedPage);
                    if (savedData) { this.pageRows = JSON.parse(savedData); }
                }

                // Load dictionary
                this.loadDictionary();

                // Close bubble when clicking outside
                document.addEventListener('click', (e) => {
                    if (this.activeBubble && !e.target.closest('.bubble-dialog-fixed') &&
                        !e.target.closest('.arab-word')) {
                        this.closeBubble();
                    }
                });
            }
        });
    </script>
</body>

</html>
